---
# General state settings
Managed: false #  if true, the FSM is managed, otherwise it is not
StepByStep: false #  if true, transitions that are tagged as StepByStep will behave as Strict transitions, otherwise they behave as Auto transitions
IdleKeepState: false #  if true, the state is kept alive until the transition is triggered by the user
StatesLibraries: # where to look for states libraries
  - "@MC_STATES_DEFAULT_RUNTIME_INSTALL_PREFIX@"
  - "@MC_STATES_RUNTIME_INSTALL_PREFIX@"
StatesFiles: #  where to look for states configuration files
  - "@MC_STATES_DEFAULT_RUNTIME_INSTALL_PREFIX@/data"
  - "@MC_STATES_RUNTIME_INSTALL_PREFIX@/data"
VerboseStateFactory: false # if true, the state factory will provide more information while loading libraries, this is useful for debugging
VerboseState: false
robots: # Additional robots (i.e. objects) to load apart from main robot
  ground:
    module: env/ground

# General constraints to include in the optimization problem, each constraint is representation of a mc_solver::ConstraintSet object
constraints:
  - type: contact # Handle geometric constraints on contacts
  - type: dynamics # Handle dynamics constraints (equation of motion) for a robot
    damper: [0.1, 0.01, 0.5]
  - type: compoundJoint #  Enforces mechanical coupling between linked joints as defined in the robot model
  - type: collision
    r1Index: 0
    r2Index: 0
    useCommon: true
    automaticMonitor: true
    collisions: # Explicit collision pairs for self-collision monitoring test (add more pairs as needed)
      - body1: L_WRIST_Y_S
        body2: WAIST_R_S
        iDist: 0.5
        sDist: 0.02
        damping: 0.0
      - body1: R_WRIST_Y_S
        body2: WAIST_R_S
        iDist: 0.5
        sDist: 0.02
        damping: 0.0

# Setup foot contacts
contacts:
  - r1: jvrc1
    r1Surface: LeftFoot
    r2: ground
    r2Surface: AllGround
  - r1: jvrc1
    r1Surface: RightFoot
    r2: ground
    r2Surface: AllGround

# Robot specific options
jvrc1:
  posture:
    stiffness: 1.0
    weight: 10.0

target_poses:
  left_hand_init_pose:
    frame: LeftGripper
    useInitial: true
  right_hand_init_pose:
    frame: RightGripper
    useInitial: true
  left_hand_target_pose:
    frame: LeftGripper
    translation: [0.5, 0.25, 1.1]
    rotation: [0.0, 0.7, 0.0, 0.7] # w, x, y, z
  right_hand_target_pose:
    frame: RightGripper
    translation: [0.5, -0.25, 1.1]
    rotation: [0.0, 0.7, 0.0, 0.7] # w, x, y, z

# FSM states
states:
  SimpleHumanoidController::BaseStabilize:
    base: MetaTasks
    tasks:
      CoM:
        type: com
        above: [LeftFoot, RightFoot]
        weight: 2000
        stiffness: 5
      KeepChest:
        type: orientation
        frame: WAIST_R_S
        weight: 100
        stiffness: 1

  SimpleHumanoidController::LookForward:
    base: MetaTasks
    tasks:
      LookForward:
        type: posture
        activeJoints: ["NECK_P", "NECK_Y"]
        weight: 500
        stiffness: 5.0
        damping: 5.0
        posture:
          - [0.0]
          - [0.0]
        completion:
          AND:
            - eval: 0.05
            - speed: 1e-4

  SimpleHumanoidController::BaseLookAtHand:
    base: MetaTasks
    tasks:
      LookAtHand:
        type: lookAtSurface
        frame: camera_frame
        frameVector: [0, 0, 1]
        weight: 300
        stiffness: 5.0
        damping: 5.0
        activeJoints: ["NECK_P", "NECK_Y"]
        target:
          frame: target_hand_frame
        completion:
          AND:
            - eval: 0.05
            - speed: 1e-4

  SimpleHumanoidController::LookAtLeftHand:
    base: SimpleHumanoidController::BaseLookAtHand
    tasks:
      LookAtHand:
        name: LookAtLeftHand
        frame: lcamera
        target:
          frame: LeftGripper

  SimpleHumanoidController::LookAtRightHand:
    base: SimpleHumanoidController::BaseLookAtHand
    tasks:
      LookAtHand:
        name: LookAtRightHand
        frame: rcamera
        target:
          frame: RightGripper

  SimpleHumanoidController::MoveLeftHandToInitial:
    base: SimpleHumanoidController_BaseMoveHand
    target_pose_key: left_hand_init_pose
    task_name: MoveLeftHandToInitial

  SimpleHumanoidController::MoveLeftHandToTarget:
    base: SimpleHumanoidController_BaseMoveHand
    target_pose_key: left_hand_target_pose
    task_name: MoveLeftHandToTarget

  SimpleHumanoidController::MoveRightHandToInitial:
    base: SimpleHumanoidController_BaseMoveHand
    target_pose_key: right_hand_init_pose
    task_name: MoveRightHandToInitial

  SimpleHumanoidController::MoveRightHandToTarget:
    base: SimpleHumanoidController_BaseMoveHand
    target_pose_key: right_hand_target_pose
    task_name: MoveRightHandToTarget

  SimpleHumanoidController::LeftHandToTarget:
    base: Parallel
    states: ["SimpleHumanoidController::MoveLeftHandToTarget", "SimpleHumanoidController::LookAtLeftHand"]

  SimpleHumanoidController::RightHandToTarget:
    base: Parallel
    states: ["SimpleHumanoidController::MoveRightHandToTarget", "SimpleHumanoidController::LookAtRightHand"]

  SimpleHumanoidController::LeftHandToInitial:
    base: Parallel
    states: ["SimpleHumanoidController::MoveLeftHandToInitial", "SimpleHumanoidController::LookAtLeftHand"]

  SimpleHumanoidController::RightHandToInitial:
    base: Parallel
    states: ["SimpleHumanoidController::MoveRightHandToInitial", "SimpleHumanoidController::LookAtRightHand"]

  SimpleHumanoidController::BothHandsToTarget:
    base: Parallel
    states:
      [
        "SimpleHumanoidController::MoveLeftHandToTarget",
        "SimpleHumanoidController::MoveRightHandToTarget",
        "SimpleHumanoidController::LookForward",
      ]

  SimpleHumanoidController::BothHandsToInitial:
    base: Parallel
    states:
      [
        "SimpleHumanoidController::MoveLeftHandToInitial",
        "SimpleHumanoidController::MoveRightHandToInitial",
        "SimpleHumanoidController::LookForward",
      ]

  SimpleHumanoidController::ExecuteFSM:
    base: Meta
    transitions:
      - [SimpleHumanoidController::LeftHandToTarget, OK, SimpleHumanoidController::LeftHandToInitial, Auto]
      - [SimpleHumanoidController::LeftHandToInitial, OK, SimpleHumanoidController::RightHandToTarget, Auto]
      - [SimpleHumanoidController::RightHandToTarget, OK, SimpleHumanoidController::RightHandToInitial, Auto]
      - [SimpleHumanoidController::RightHandToInitial, OK, SimpleHumanoidController::BothHandsToTarget, Auto]
      - [SimpleHumanoidController::BothHandsToTarget, OK, SimpleHumanoidController::BothHandsToInitial, Auto]
      - [SimpleHumanoidController::BothHandsToInitial, OK, SimpleHumanoidController::LeftHandToTarget, Auto]

  SimpleHumanoidController::Demo:
    base: Parallel
    states: ["SimpleHumanoidController::BaseStabilize", "SimpleHumanoidController::ExecuteFSM"]

transitions:
  - [SimpleHumanoidController::Demo, OK, SimpleHumanoidController::Demo, Auto]

init: SimpleHumanoidController::Demo
